<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarbonAra Certificate Tool</title>
    <style>
        /* Basic styling for the application */
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 1px solid #ccc; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #007bff; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #previewCanvas { border: 1px solid #ccc; max-width: 100%; height: auto; }
        #verify-result { text-align: center; }
        #auth-animation { width: 100px; height: 100px; margin: auto; }
        #diagnostics { background: #eee; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>

<div class="container">
    <h1>CarbonAra Certificate Tool</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="showTab('generate')">Generate</button>
        <button class="tab-button" onclick="showTab('verify')">Verify</button>
    </div>

    <!-- Generate Pane -->
    <div id="pane-generate" class="tab-content active">
        <div class="grid">
            <div>
                <h3>Certificate Details</h3>
                <div class="form-group">
                    <label for="input-name">Name</label>
                    <input type="text" id="input-name" value="John Doe">
                </div>
                <div class="form-group">
                    <label for="input-amount">Amount</label>
                    <input type="text" id="input-amount" value="100">
                </div>
                <div class="form-group">
                    <label for="input-date">Date</label>
                    <input type="date" id="input-date">
                </div>
                <div class="form-group">
                    <label for="input-type">Type</label>
                    <input type="text" id="input-type" value="Carbon Credit">
                </div>
                <div class="form-group">
                    <label for="input-dpi">DPI</label>
                    <select id="input-dpi">
                        <option value="150">150</option>
                        <option value="300" selected>300</option>
                    </select>
                </div>
                <button id="btn-export-pdf">Export PDF</button>
                <button id="btn-reset-positions">Reset Positions</button>
            </div>
            <div>
                <h3>Preview</h3>
                <canvas id="previewCanvas"></canvas>
                <div class="form-group">
                    <label>Name Position (X, Y)</label>
                    <input type="number" id="input-x-name"> <input type="number" id="input-y-name">
                </div>
                 <div class="form-group">
                    <label>Amount Position (X, Y)</label>
                    <input type="number" id="input-x-amount"> <input type="number" id="input-y-amount">
                </div>
                 <div class="form-group">
                    <label>Date Position (X, Y)</label>
                    <input type="number" id="input-x-date"> <input type="number" id="input-y-date">
                </div>
                 <div class="form-group">
                    <label>Type Position (X, Y)</label>
                    <input type="number" id="input-x-type"> <input type="number" id="input-y-type">
                </div>
            </div>
        </div>
    </div>

    <!-- Verify Pane -->
    <div id="pane-verify" class="tab-content">
        <div class="form-group">
            <label for="file-upload">Upload PDF or Image</label>
            <input type="file" id="file-upload" accept=".pdf,.png,.jpg,.jpeg">
        </div>
        <div id="verify-result">
            <div id="auth-animation"></div>
            <h3 id="auth-prob"></h3>
        </div>
        <div class="form-group">
            <input type="checkbox" id="expert-toggle">
            <label for="expert-toggle">Show Expert Diagnostics</label>
        </div>
        <div id="diagnostics" style="display:none;"></div>
    </div>
</div>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script>
    // Mock image data (replace with your actual image.png)
    const imageSrc = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='; // 1x1 transparent png

    // Mock font data (replace with your actual base64 encoded fonts)
    const greatVibesFont = '/* Base64 for Great Vibes font */';
    const montserratFont = '/* Base64 for Montserrat font */';

    // Application logic
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const image = new Image();

        // Input fields
        const inputs = {
            name: document.getElementById('input-name'),
            amount: document.getElementById('input-amount'),
            date: document.getElementById('input-date'),
            type: document.getElementById('input-type'),
            dpi: document.getElementById('input-dpi'),
            xName: document.getElementById('input-x-name'),
            yName: document.getElementById('input-y-name'),
            xAmount: document.getElementById('input-x-amount'),
            yAmount: document.getElementById('input-y-amount'),
            xDate: document.getElementById('input-x-date'),
            yDate: document.getElementById('input-y-date'),
            xType: document.getElementById('input-x-type'),
            yType: document.getElementById('input-y-type'),
        };

        // Set today's date
        inputs.date.valueAsDate = new Date();

        let textElements = {};

        function drawCanvas() {
            if (!image.src) return;
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.drawImage(image, 0, 0);

            // Draw text elements
            Object.values(textElements).forEach(el => {
                ctx.font = `${el.fontSize}px ${el.font}`;
                ctx.fillStyle = 'black';
                ctx.fillText(el.text, el.x, el.y);
            });
        }

        function updateTextElements() {
            textElements = {
                name: {
                    text: inputs.name.value,
                    x: parseFloat(inputs.xName.value),
                    y: parseFloat(inputs.yName.value),
                    font: 'Great Vibes',
                    fontSize: 50,
                    draggable: true
                },
                amount: {
                    text: `Amount: ${inputs.amount.value}`,
                    x: parseFloat(inputs.xAmount.value),
                    y: parseFloat(inputs.yAmount.value),
                    font: 'Montserrat',
                    fontSize: 9,
                    draggable: true
                },
                date: {
                    text: `Date: ${inputs.date.value}`,
                    x: parseFloat(inputs.xDate.value),
                    y: parseFloat(inputs.yDate.value),
                    font: 'Montserrat',
                    fontSize: 9,
                    draggable: true
                },
                type: {
                    text: `Type: ${inputs.type.value}`,
                    x: parseFloat(inputs.xType.value),
                    y: parseFloat(inputs.yType.value),
                    font: 'Montserrat',
                    fontSize: 9,
                    draggable: true
                }
            };
            drawCanvas();
        }

        function resetPositions() {
            const centerX = image.width / 2;
            inputs.xName.value = centerX - (ctx.measureText(inputs.name.value).width / 2);
            inputs.yName.value = image.height / 2;

            inputs.xAmount.value = image.width - 200;
            inputs.yAmount.value = image.height - 50;
            inputs.xDate.value = image.width - 200;
            inputs.yDate.value = image.height - 40;
            inputs.xType.value = image.width - 200;
            inputs.yType.value = image.height - 30;

            updateTextElements();
        }

        image.onload = () => {
            resetPositions();
        };
        image.src = imageSrc;

        // Event listeners for input changes
        Object.values(inputs).forEach(input => {
            input.addEventListener('input', updateTextElements);
        });

        document.getElementById('btn-reset-positions').addEventListener('click', resetPositions);

        // Drag and drop functionality
        let dragging = false;
        let selectedElement = null;
        let offset = { x: 0, y: 0 };

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
            const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);

            for (const key in textElements) {
                const el = textElements[key];
                if (el.draggable) {
                    ctx.font = `${el.fontSize}px ${el.font}`;
                    const textWidth = ctx.measureText(el.text).width;
                    if (mouseX >= el.x && mouseX <= el.x + textWidth && mouseY >= el.y - el.fontSize && mouseY <= el.y) {
                        dragging = true;
                        selectedElement = key;
                        offset.x = mouseX - el.x;
                        offset.y = mouseY - el.y;
                        break;
                    }
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (dragging && selectedElement) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const mouseY = (e.clientY - rect.top) * (canvas.height / rect.height);

                textElements[selectedElement].x = mouseX - offset.x;
                textElements[selectedElement].y = mouseY - offset.y;

                // Update corresponding input fields
                inputs[`x${capitalize(selectedElement)}`].value = textElements[selectedElement].x.toFixed(2);
                inputs[`y${capitalize(selectedElement)}`].value = textElements[selectedElement].y.toFixed(2);

                drawCanvas();
            }
        });

        canvas.addEventListener('mouseup', () => {
            dragging = false;
            selectedElement = null;
        });

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // PDF Export
        document.getElementById('btn-export-pdf').addEventListener('click', async () => {
            const { PDFDocument } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([canvas.width, canvas.height]);

            const pngImageBytes = await fetch(canvas.toDataURL('image/png')).then(res => res.arrayBuffer());
            const pngImage = await pdfDoc.embedPng(pngImageBytes);

            page.drawImage(pngImage, {
                x: 0,
                y: 0,
                width: canvas.width,
                height: canvas.height,
            });

            // Add QR code
            const qr = new QRious({
                value: 'https://example.com/verify?data=...', // Replace with actual data
                size: 100
            });
            const qrImageBytes = await fetch(qr.toDataURL()).then(res => res.arrayBuffer());
            const qrImage = await pdfDoc.embedPng(qrImageBytes);
            page.drawImage(qrImage, {
                x: page.getWidth() - 120,
                y: 20,
                width: 100,
                height: 100
            });

            const pdfBytes = await pdfDoc.save();
            download(pdfBytes, `CarbonCert-${inputs.date.value}.pdf`, 'application/pdf');
        });

        function download(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Tab switching
        window.showTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`pane-${tabName}`).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        };

        // Expert toggle
        document.getElementById('expert-toggle').addEventListener('change', (e) => {
            document.getElementById('diagnostics').style.display = e.target.checked ? 'block' : 'none';
        });
    });
</script>

</body>
</html>
